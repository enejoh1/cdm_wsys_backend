<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

 <mapper namespace="item">
	<resultMap id="result" type="item">
		<result property="unique_id" 		column="unique_id" 			javaType="java.lang.Long" />
		<result property="uid_company" 		column="uid_company" 		javaType="java.lang.Long" />
		<result property="item_code" 		column="item_code" />
		<result property="item_name" 		column="item_name" />
		<result property="specification" 	column="specification" />
		<result property="detail_info" 		column="detail_info" />
		<result property="unit_code" 		column="unit_code" />
		<result property="safe_quan" 		column="safe_quan" 			javaType="java.lang.Double" />
		<result property="remark" 			column="remark" />
		<result property="sum_quan" 		column="sum_quan" 			javaType="java.lang.Double" />

		<result property="del_yn" 			column="del_yn" />
		<result property="creator" 			column="creator" />
		<result property="creator_uid" 		column="creator_uid" 	javaType="java.lang.Long" />
		<result property="create_date" 		column="create_date" 	javaType="java.util.Date" />
		<result property="changer" 			column="changer" />
		<result property="changer_uid" 		column="changer_uid" 	javaType="java.lang.Long" />
		<result property="change_date" 		column="change_date" 	javaType="java.util.Date" />
		<result property="expiration_period" 		column="expiration_period" 		javaType="java.util.Date" />
		<result property="supply_name" 				column="supply_name" />
		<result property="batch_lot_id" 			column="batch_lot_id" />
		<result property="supply_lot_number" 		column="supply_lot_number" />
		<result property="supply_company_name" 		column="supply_company_name" />
	</resultMap>

	<insert id="insert-item" parameterType="user">
		INSERT INTO TB_ITEM
			(
			 unique_id, uid_company, item_code, item_name, specification, detail_info, unit_code, safe_quan, remark,
			 creator_uid, creator, create_date, expiration_period, supply_name, batch_lot_id, supply_lot_number, supply_company_name
			)
		VALUES
		 	(
		 	 #{unique_id}, #{uid_company}, #{item_code}, #{item_name}, #{specification}, #{detail_info}, #{unit_code}, #{safe_quan}, #{remark},
		 	 #{creator_uid}, #{creator}, #{create_date}, #{expiration_period}, #{supply_name}, #{batch_lot_id}, #{supply_lot_number}, #{supply_company_name}
		 	)
		 ON DUPLICATE KEY UPDATE
		 	change_date = now(),
		 	del_yn = 'N',
		 	item_name = #{item_name},
		 	specification = #{specification},
		 	detail_info = #{detail_info},
		 	unit_code = #{unit_code},
		 	safe_quan = #{safe_quan},
		 	remark = #{remark},
		 	creator_uid = #{creator_uid},
		 	creator = #{creator}

	</insert>

	<insert id="insert-item-upload" parameterType="user">
		INSERT INTO TB_ITEM
			(
			 unique_id, uid_company, item_code, item_name, specification, detail_info, unit_code, safe_quan, remark,
			 creator_uid, creator, create_date, expiration_period, supply_name, batch_lot_id, supply_lot_number, supply_company_name
			)
		VALUES
		 	(
		 	 #{unique_id}, #{uid_company}, #{item_code}, #{item_name}, #{specification}, #{detail_info}, #{unit_code}, #{safe_quan}, #{remark},
		 	 #{creator_uid}, #{creator}, #{create_date}, #{expiration_period}, #{supply_name}, #{batch_lot_id}, #{supply_lot_number}, #{supply_company_name}
		 	)
		 ON DUPLICATE KEY UPDATE
		 	change_date = now(),
		 	del_yn = 'N
		 	item_name = #{item_name},
		 	specification = #{specification},
		 	detail_info = #{detail_info},
		 	unit_code = #{unit_code},
		 	safe_quan = #{safe_quan},
		 	remark = #{remark},
		 	creator_uid = #{creator_uid},
		 	creator = #{creator}

	</insert>

	<sql id="select-item-fields">
		item.*,
		NVL((SELECT SUM(quan) FROM tb_location where del_yn = 'N' AND uid_item = item.unique_id GROUP BY uid_item), 0) as sum_quan,
		NVL((SELECT COUNT(*) FROM tb_history his join tb_location locate on locate.unique_id = his.uid_location and locate.uid_item = item.unique_id where his.is_inout = 'IN'), 0) as history_in,
		NVL((SELECT COUNT(*) FROM tb_history his join tb_location locate on locate.unique_id = his.uid_location and locate.uid_item = item.unique_id where his.is_inout = 'OUT'), 0) as history_out

	</sql>

	<sql id="select-item-join">
		FROM TB_ITEM item
	</sql>

   <sql id="select-item-where">
		WHERE item.del_yn='N'
		<if test="uid_company">		AND item.uid_company 		= 		#{uid_company}</if>
		<if test="item_code">		AND UPPER(item.item_code) 	LIKE 	UPPER(#{item_code})</if>
		<if test="item_name">		AND UPPER(item.item_name)	LIKE 	UPPER(#{item_name})</if>
		<if test="specification">	AND UPPER(item.specification) LIKE 	UPPER(#{specification})</if>
		<if test="detail_info">		AND UPPER(item.detail_info) LIKE 	UPPER(#{detail_info})</if>
		<if test="unit_code">		AND UPPER(item.unit_code) 	LIKE 	UPPER(#{unit_code})</if>
		<if test="safe_quan">		AND item.safe_quan 			= 		#{safe_quan}</if>
		<if test="remark">			AND item.remark 			= 		#{remark}</if>

		<if test="barcode">			AND item.item_code 			= 		#{barcode}</if>

		<if test="creator_uid">		AND	item.creator_uid 	= 		#{creator_uid}</if>
		<if test="creator">			AND	item.creator 		like 	#{creator}</if>
		<if test="create_date">		AND DATE_FORMAT(item.create_date, '%Y-%m-%d') BETWEEN #{create_date_s} AND #{create_date_e}</if>
		<if test="changer_uid">		AND	item.changer_uid 	= 		#{changer_uid}</if>
		<if test="changer">			AND	item.changer 		like 	#{changer}</if>
		<if test="change_date">		AND DATE_FORMAT(item.change_date, '%Y-%m-%d') BETWEEN #{change_date_s} AND #{change_date_e}</if>

		<if test="search_item">
			AND (
				UPPER(item.item_name) LIKE UPPER(#{search_item}) OR
				UPPER(item.item_code) LIKE UPPER(#{search_item})
			)
		</if>

		<if test="unique_id">		AND	item.unique_id 		= 		#{unique_id}</if>

	</sql>

	<select id="selectuid-item" parameterType="java.lang.Long" resultMap="result">
		/*selectcond-item*/SELECT
		<include refid="select-item-fields" />
		<include refid="select-item-join" />
		WHERE item.del_yn='N' AND item.unique_id=#{value}
	</select>

	<select id="selectcond-item" parameterType="map" resultMap="result">
		/*selectcond-item*/SELECT
		<include refid="select-item-fields" />
		<include refid="select-item-join" />
		<include refid="select-item-where" />
	</select>

	<select id="selectcond-item-count" parameterType="map" resultType="Integer">
		/*selectcond-item-count*/SELECT
		COUNT(*) AS result
		<include refid="select-item-join" />
		<include refid="select-item-where" />
	</select>

	<select id="selectcond-item-page" parameterType="map" resultMap="result">
		/*selectcond-item-page*/SELECT
		<include refid="select-item-fields" />
		<include refid="select-item-join" />
		<include refid="select-item-where" />
		${order_by}
		limit ${start_point} , ${end_point}
	</select>

	<sql id= "update-bymap-item-set" >
		SET
			del_yn='N'
			<if test= "changer_uid"> 	,changer_uid 	= #{changer_uid} </if>
			<if test= "changer"> 		,changer 		= #{changer} </if>
			<if test= "change_date"> 	,change_date 	= #{change_date} </if>

			<if test= "item_code"> 		,item_code 		= #{item_code} </if>
			<if test= "item_name"> 		,item_name 		= #{item_name} </if>
			<if test= "specification"> 	,specification 	= #{specification} </if>
			<if test= "detail_info"> 	,detail_info 	= #{detail_info} </if>
			<if test= "unit_code"> 		,unit_code 	= #{unit_code} </if>
			<if test= "safe_quan"> 		,safe_quan 		= #{safe_quan} </if>
			<if test= "remark"> 		,remark 		= #{remark} </if>
			<if test= "expiration_period"> 		,expiration_period 		= #{expiration_period} </if>
			<if test= "supply_name"> 			,supply_name 			= #{supply_name} </if>
			<if test= "batch_lot_id"> 			,batch_lot_id 			= #{batch_lot_id} </if>
			<if test= "supply_lot_number"> 		,supply_lot_number 		= #{supply_lot_number} </if>
			<if test= "supply_company_name"> 	,supply_company_name 	= #{supply_company_name} </if>
	</sql>

	<update id= "update-bymap-item" parameterType = "map">
      /*update-bymap-item*/
      UPDATE TB_ITEM
      	<include refid= "update-bymap-item-set" />
      WHERE
      	unique_id = #{unique_id}
      	AND del_yn='N'
	</update >

	<update id="delete-bymap-item" parameterType="map">
		UPDATE TB_ITEM
		SET
			changer_uid = #{changer_uid},
			changer = #{changer},
			change_date=#{change_date},
			del_yn = 'Y'
		where unique_id=#{unique_id}
	</update>

	<select id="getUidItemByItemCode" parameterType="map" resultType="Long">
		/*getUidItemByItemCode*/SELECT
		unique_id as result
		FROM tb_item
		WHERE del_yn = 'N'
		AND uid_company = #{uid_company}
		AND item_code = #{item_code}
	</select>

</mapper>
